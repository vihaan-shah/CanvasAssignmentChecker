#!/usr/bin/env python3
"""
Canvas Assignment Email Notifier

Sends Canvas assignment check results via Gmail.
Reads the assignment check output from stdin and emails it.

Requirements: Python 3.x (built-in libraries only)
"""

import smtplib
import sys
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

def send_email(subject, body, to_email, gmail_user, gmail_app_password):
    """
    Send email using Gmail SMTP server.
    
    Args:
        subject: Email subject line
        body: Email body content
        to_email: Recipient email address
        gmail_user: Sender Gmail address
        gmail_app_password: Gmail App Password (NOT regular password)
    
    Returns:
        True if email sent successfully, False otherwise
    """
    
    msg = MIMEMultipart()
    msg['From'] = gmail_user
    msg['To'] = to_email
    msg['Subject'] = subject
    
    msg.attach(MIMEText(body, 'plain'))
    
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(gmail_user, gmail_app_password)
        text = msg.as_string()
        server.sendmail(gmail_user, to_email, text)
        server.quit()
        print("Email sent successfully!")
        return True
    except Exception as e:
        print(f"Failed to send email: {e}")
        return False

if __name__ == "__main__":
    # Read canvas output from stdin
    canvas_output = sys.stdin.read()
    
    # Gmail credentials - CONFIGURE THESE BEFORE USE
    # Generate an App Password at: https://myaccount.google.com/apppasswords
    GMAIL_USER = "your-email@gmail.com"  # Your Gmail address
    GMAIL_APP_PASSWORD = "your-app-password-here"  # 16-character Gmail App Password
    TO_EMAIL = "your-email@gmail.com"  # Recipient email (can be same as GMAIL_USER)
    
    # Validate configuration
    if GMAIL_USER == "your-email@gmail.com" or GMAIL_APP_PASSWORD == "your-app-password-here":
        print("ERROR: Please configure your Gmail credentials in send_email.py")
        print("See README.md for setup instructions")
        sys.exit(1)
    
    # Send the email
    send_email(
        subject="Canvas Assignment Check - Daily Report",
        body=canvas_output,
        to_email=TO_EMAIL,
        gmail_user=GMAIL_USER,
        gmail_app_password=GMAIL_APP_PASSWORD
    )
